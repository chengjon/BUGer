# Research Phase: BUG ç®¡ç†çŸ¥è¯†åº“ç³»ç»Ÿ

**Feature**: BUG ç®¡ç†çŸ¥è¯†åº“ç³»ç»Ÿ | **Date**: 2025-10-27 | **Branch**: `001-bug-management`

## ç ”ç©¶æ€»ç»“

æœ¬é˜¶æ®µå¯¹ç³»ç»Ÿçš„å…³é”®æŠ€æœ¯é€‰å‹è¿›è¡Œäº†æ·±å…¥ç ”ç©¶ï¼ŒåŒ…æ‹¬æ•°æ®åº“æœç´¢ä¼˜åŒ–ã€é€Ÿç‡é™åˆ¶å®ç°ã€æ•°æ®å­˜å‚¨ç­–ç•¥å’Œé«˜å¯ç”¨æ¶æ„è®¾è®¡ã€‚

## 1. MongoDB å…¨æ–‡æœç´¢ä¼˜åŒ–

### å†³ç­–ï¼šé‡‡ç”¨ MongoDB Atlas Search

**ç†ç”±**ï¼š
- Atlas Search æœç´¢é€Ÿåº¦å¿« 60%ï¼Œæ”¯æŒ 10,000+ å¹¶å‘æŸ¥è¯¢
- å¼‚æ­¥ç´¢å¼•æ›´æ–°ï¼Œä¸å½±å“å†™æ€§èƒ½
- æ”¯æŒå¤šä¸ªä¸“ä¸šåŒ–ç´¢å¼•ï¼Œæ»¡è¶³ä¸åŒæœç´¢åœºæ™¯
- åŸºäº Apache Lucene å¼•æ“ï¼Œè¡Œä¸šæ ‡å‡†

**å¯¹æ ‡æ–¹æ¡ˆ**ï¼š
- MongoDB Text Indexï¼šæ€§èƒ½ä¸è¶³ï¼Œå¹¶å‘èƒ½åŠ›å¼±ï¼Œä»…æ”¯æŒ 1 ä¸ªç´¢å¼•
- è‡ªå»ºæœç´¢ç³»ç»Ÿï¼šå®ç°å¤æ‚ï¼Œç»´æŠ¤æˆæœ¬é«˜

### ç´¢å¼•ç­–ç•¥

```javascript
// ä¸»æœç´¢ç´¢å¼•é…ç½®
{
  "analyzer": "lucene.standard",
  "mappings": {
    "dynamic": false,
    "fields": {
      "title": {
        "type": "string",
        "analyzer": "lucene.standard",
        "foldDiacritics": false,
        "indexOptions": "offsets",
        "store": false
      },
      "description": {
        "type": "string",
        "analyzer": "lucene.english",
        "foldDiacritics": false
      },
      "errorCode": {
        "type": "string",
        "analyzer": "lucene.keyword",
        "indexOptions": "offsets"
      },
      "stackTrace": {
        "type": "string",
        "analyzer": "lucene.whitespace"
      },
      "severity": {
        "type": "string",
        "analyzer": "lucene.keyword"
      },
      "status": {
        "type": "string",
        "analyzer": "lucene.keyword"
      },
      "projectId": {
        "type": "string",
        "analyzer": "lucene.keyword"
      },
      "tags": {
        "type": "stringFacet"
      },
      "createdAt": {
        "type": "date"
      }
    }
  }
}
```

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡

- **æŸ¥è¯¢å»¶è¿Ÿ**ï¼šP95 < 1ç§’ï¼ŒP99 < 2ç§’
- **å¹¶å‘èƒ½åŠ›**ï¼šæ”¯æŒ 10,000+ å¹¶å‘æŸ¥è¯¢
- **ç´¢å¼•æ›´æ–°å»¶è¿Ÿ**ï¼š< 5 ç§’
- **å¯ç”¨æ€§**ï¼š99.9%+

## 2. API é€Ÿç‡é™åˆ¶å®ç°

### å†³ç­–ï¼šRedis + æ»‘åŠ¨çª—å£ç®—æ³•

**ç†ç”±**ï¼š
- Redis æä¾›åŸå­æ“ä½œï¼Œç¡®ä¿åˆ†å¸ƒå¼ç¯å¢ƒä¸€è‡´æ€§
- æ»‘åŠ¨çª—å£ç®—æ³•ç²¾ç¡®åº¦é«˜ï¼Œé€‚åˆç²¾ç¡®çš„ 200 req/min é™åˆ¶
- å®ç°ç®€å•ï¼Œæ€§èƒ½é«˜æ•ˆ

**é™æµé…ç½®**ï¼š
- æ¯é¡¹ç›®æ¯åˆ†é’Ÿ 200 æ¬¡è¯·æ±‚
- è¶…é¢è¯·æ±‚è¿”å› 429 çŠ¶æ€ç 
- è¿”å›å‰©ä½™é…é¢å’Œé‡ç½®æ—¶é—´

### å®ç°ä¼ªä»£ç 

```javascript
// Redis æ»‘åŠ¨çª—å£é™æµ
async function checkRateLimit(apiKey) {
  const now = Date.now();
  const windowStart = now - 60000; // 1åˆ†é’Ÿçª—å£
  const key = `ratelimit:${apiKey}`;

  // åˆ é™¤è¿‡æœŸè®°å½•
  await redis.zremrangebyscore(key, 0, windowStart);

  // è·å–çª—å£å†…è¯·æ±‚æ•°
  const count = await redis.zcard(key);

  if (count >= 200) {
    return {
      allowed: false,
      remaining: 0,
      reset: Math.ceil((await redis.zrange(key, 0, 0, 'WITHSCORES'))[1] / 1000) + 60
    };
  }

  // è®°å½•å½“å‰è¯·æ±‚
  await redis.zadd(key, now, `${now}:${Math.random()}`);
  await redis.expire(key, 60);

  return {
    allowed: true,
    remaining: 200 - count - 1,
    reset: Math.ceil(now / 1000) + 60
  };
}
```

## 3. æ•°æ®æ°¸ä¹…å­˜å‚¨ç­–ç•¥

### å†³ç­–ï¼šMongoDB åˆ†ç‰‡ + æŒ‰æœˆåˆ†åŒº

**ç†ç”±**ï¼š
- åˆ†ç‰‡æ”¯æŒæ— é™æ‰©å±•å­˜å‚¨
- æŒ‰æœˆåˆ†åŒºä¾¿äºæ•°æ®ç®¡ç†å’Œå½’æ¡£
- æ”¯æŒçƒ­å†·æ•°æ®åˆ†ç¦»

**åˆ†ç‰‡ç­–ç•¥**ï¼š
- Shard Keyï¼š`projectId` å’Œ `createdAt` çš„å¤åˆé”®
- åˆ†ç‰‡æ•°ï¼šåˆå§‹ 4 ä¸ªï¼ŒåæœŸå¯æ‰©å±•
- æ•°æ®ç”Ÿå‘½å‘¨æœŸï¼šæ°¸ä¹…ä¿å­˜ï¼ŒæŒ‰å¹´å½’æ¡£åˆ°å†·å­˜å‚¨

### å­˜å‚¨å®¹é‡è§„åˆ’

```
å‡è®¾åœºæ™¯ï¼š
- 100 ä¸ªé¡¹ç›®
- å¹³å‡æ¯ä¸ªé¡¹ç›®æ¯å¤© 1000 æ¡ BUG
- å¹³å‡ BUG è®°å½• 2KB

è®¡ç®—ï¼š
100 Ã— 1000 Ã— 2KB = 200MB/å¤©
200MB/å¤© Ã— 365å¤© = 73GB/å¹´
10å¹´ = 730GB

å»ºè®®ï¼š
- M50 é›†ç¾¤èµ·æ­¥ï¼ˆæœ€å¤§ 2TBï¼‰
- é¢„ç•™ 50% æ‰©å±•ç©ºé—´
- å»ºç«‹å¹´åº¦å½’æ¡£ç­–ç•¥
```

## 4. é«˜å¯ç”¨æ¶æ„è®¾è®¡

### å†³ç­–ï¼šMongoDB å‰¯æœ¬é›† + API æœåŠ¡é›†ç¾¤

**æ¶æ„å›¾**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Client Applications (SDKs)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          â”‚          â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ API-1 â”‚  â”‚ API-2 â”‚  â”‚ API-3  â”‚
    â”‚(Node) â”‚  â”‚(Node) â”‚  â”‚ (Node) â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚          â”‚         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚    Redis Cache Layer          â”‚
    â”‚  (Rate Limiting + Cache)      â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MongoDB Replica Set (3 nodes)â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â”‚ Primary (Writes)           â”‚
    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â”‚ Secondary 1 (Reads)        â”‚
    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â”‚ Secondary 2 (Backup)       â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•…éšœè½¬ç§»**ï¼š
- MongoDB è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆ< 30 ç§’ï¼‰
- API æœåŠ¡æ— çŠ¶æ€ï¼Œå¯ç›´æ¥æ›¿æ¢
- å¥åº·æ£€æŸ¥é—´éš” 10 ç§’
- è‡ªåŠ¨é‡è¿æœºåˆ¶

## 5. å®¢æˆ·ç«¯ SDK é›†æˆæ–¹æ¡ˆ

### æ”¯æŒçš„é›†æˆæ–¹å¼

**è‡ªåŠ¨æ•è·ï¼ˆæ¨èï¼‰**ï¼š
```javascript
const BugerClient = require('buger-client');
const buger = new BugerClient({
  apiKey: process.env.BUGER_API_KEY,
  endpoint: 'https://buger.example.com'
});

// è‡ªåŠ¨æ•è·æœªå¤„ç†å¼‚å¸¸
process.on('uncaughtException', (error) => {
  buger.report(error);
});
```

**æ‰‹åŠ¨ä¸ŠæŠ¥**ï¼š
```javascript
buger.report({
  title: 'ç”¨æˆ·ç™»å½•å¤±è´¥',
  category: 'è®¤è¯',
  severity: 'high',
  context: { userId: 123 }
});
```

**ç¦»çº¿ç¼“å­˜**ï¼š
- ç½‘ç»œæ–­å¼€æ—¶ç¼“å­˜ BUG æŠ¥å‘Š
- æœ€å¤šç¼“å­˜ 1000 æ¡
- æ¢å¤åè‡ªåŠ¨é‡è¯•
- æ”¯æŒæ‰¹é‡ä¸ŠæŠ¥

## 6. æ€§èƒ½ä¼˜åŒ–å…³é”®ç‚¹

### ç¼“å­˜ç­–ç•¥

| å¯¹è±¡ | TTL | å‘½ä¸­ç‡ç›®æ ‡ | å½±å“ |
|------|-----|---------|------|
| æœç´¢ç»“æœ | 5åˆ†é’Ÿ | 40-60% | 10-20x åŠ é€Ÿ |
| é¡¹ç›®é…ç½® | 1å°æ—¶ | 70-80% | å‡å°‘æ•°æ®åº“æŸ¥è¯¢ |
| çƒ­ç‚¹ BUG | 15åˆ†é’Ÿ | 30-50% | çƒ­ç‚¹ä¿æŠ¤ |

### æ•°æ®åº“ä¼˜åŒ–

1. **å¤åˆç´¢å¼•**ï¼š
   - (projectId, createdAt)ï¼šé¡¹ç›®æŸ¥è¯¢
   - (severity, status)ï¼šç»Ÿè®¡æŸ¥è¯¢
   - (errorCode)ï¼šé”™è¯¯ä»£ç æŸ¥è¯¢

2. **æ‰¹é‡æ“ä½œ**ï¼š
   - æ‰¹é‡æäº¤æœ€å¤š 20 ä¸ª BUG
   - ä½¿ç”¨ bulkWrite ä¼˜åŒ–æ€§èƒ½
   - é¢„æœŸæ€§èƒ½æå‡ 5-10 å€

3. **è¿æ¥æ± **ï¼š
   - æœ€å°è¿æ¥æ•°ï¼š10
   - æœ€å¤§è¿æ¥æ•°ï¼š100
   - è¿æ¥è¶…æ—¶ï¼š30 ç§’

## 7. ç¯å¢ƒå˜é‡é…ç½®

è¯¦è§ `plan.md` çš„ `.env` éƒ¨åˆ†ã€‚

**å…³é”®é…ç½®**ï¼š
```bash
MONGODB_URI=mongodb://mongo:c790414J@192.168.123.104:27017/buger
MONGODB_DATABASE=buger
RATE_LIMIT_MAX_REQUESTS=200
BATCH_SIZE_LIMIT=20
ENABLE_ATLAS_SEARCH=true
CACHE_TTL_SEARCH=300
```

## ä¸‹ä¸€é˜¶æ®µï¼ˆPhase 1 è®¾è®¡ï¼‰

1. âœ… **å·²å®Œæˆ**ï¼šæŠ€æœ¯ç ”ç©¶å’Œå†³ç­–
2. ğŸ”„ **è¿›è¡Œä¸­**ï¼šæ•°æ®æ¨¡å‹è®¾è®¡ (data-model.md)
3. â³ **å¾…åš**ï¼šAPI å¥‘çº¦å®šä¹‰ (contracts/openapi.yaml)
4. â³ **å¾…åš**ï¼šå¿«é€Ÿå¼€å§‹æŒ‡å— (quickstart.md)

## å‚è€ƒèµ„æº

- [MongoDB Atlas Search å®˜æ–¹æ–‡æ¡£](https://www.mongodb.com/docs/atlas/atlas-search/)
- [Redis Rate Limiting æœ€ä½³å®è·µ](https://redis.io/commands/rl/)
- [Node.js Express æ€§èƒ½ä¼˜åŒ–](https://expressjs.com/en/advanced/best-practice-performance.html)